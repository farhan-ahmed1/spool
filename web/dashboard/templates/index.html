<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spool Dashboard - Real-time Task Queue Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2563eb;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --secondary-color: #6b7280;
            --bg-color: #f9fafb;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
        }

        header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-healthy {
            background-color: rgba(16, 185, 129, 0.2);
            color: var(--success-color);
        }

        .status-unhealthy {
            background-color: rgba(239, 68, 68, 0.2);
            color: var(--danger-color);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .card-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .card-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .card-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .card-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .metric-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-container {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .worker-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .worker-item {
            background: var(--bg-color);
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid var(--success-color);
            transition: all 0.2s;
        }

        .worker-item.busy {
            border-left-color: var(--warning-color);
            background: rgba(245, 158, 11, 0.05);
        }

        .worker-item.idle {
            border-left-color: var(--secondary-color);
        }

        .worker-id {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .worker-status {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-busy {
            color: var(--warning-color);
        }

        .status-idle {
            color: var(--success-color);
        }

        .task-list {
            margin-top: 20px;
        }

        .task-item {
            background: var(--bg-color);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary-color);
            cursor: pointer;
            transition: all 0.2s;
        }

        .task-item:hover {
            background: #f3f4f6;
            transform: translateX(2px);
        }

        .task-item.failed {
            border-left-color: var(--danger-color);
        }

        .task-item.completed {
            border-left-color: var(--success-color);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .task-id {
            font-family: monospace;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .task-type {
            font-weight: 600;
            color: var(--text-primary);
        }

        .task-state {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .state-pending {
            background: rgba(107, 114, 128, 0.1);
            color: var(--secondary-color);
        }

        .state-processing {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .state-completed {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .state-failed {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .refresh-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

        .tab:hover {
            color: var(--primary-color);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Activity Feed Styles */
        .activity-feed {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px 0;
        }

        .activity-feed::-webkit-scrollbar {
            width: 8px;
        }

        .activity-feed::-webkit-scrollbar-track {
            background: var(--bg-color);
            border-radius: 4px;
        }

        .activity-feed::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .activity-feed::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .activity-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            background: var(--bg-color);
            border-left: 4px solid;
            animation: slideIn 0.3s ease-out;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .activity-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow);
        }

        .activity-item.success {
            border-left-color: var(--success-color);
            background: rgba(16, 185, 129, 0.05);
        }

        .activity-item.failed {
            border-left-color: var(--danger-color);
            background: rgba(239, 68, 68, 0.05);
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .activity-item.success .activity-icon {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success-color);
        }

        .activity-item.failed .activity-icon {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger-color);
        }

        .activity-details {
            flex: 1;
            min-width: 0;
        }

        .activity-type {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .activity-meta {
            display: flex;
            gap: 12px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .activity-duration {
            font-weight: 500;
        }

        .activity-timestamp {
            margin-left: auto;
            font-size: 0.75rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            header h1 {
                font-size: 1.5rem;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .card-value {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>
                Spool Dashboard
                <span id="queueHealth" class="status-badge status-healthy">Healthy</span>
            </h1>
            <p>Real-time monitoring for your distributed task queue system</p>
            <p style="font-size: 0.875rem; margin-top: 8px;">
                Uptime: <strong id="uptime">--</strong> | 
                Last Updated: <strong id="lastUpdated">--</strong>
            </p>
        </div>
    </header>

    <div class="container">
        <!-- Key Metrics -->
        <div class="grid">
            <div class="card">
                <div class="card-title">Queue Depth</div>
                <div class="card-value" id="queueDepth">--</div>
                <div class="card-subtitle">
                    <span style="color: var(--danger-color);">High: <span id="queueDepthHigh">--</span></span> | 
                    <span style="color: var(--success-color);">Low: <span id="queueDepthLow">--</span></span>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Active Workers</div>
                <div class="card-value" id="activeWorkers">--</div>
                <div class="card-subtitle">
                    <span style="color: var(--warning-color);">Busy: <span id="busyWorkers">--</span></span> | 
                    <span style="color: var(--success-color);">Idle: <span id="idleWorkers">--</span></span>
                </div>
                <div class="card-metric">
                    <span class="metric-label">Utilization</span>
                    <span class="metric-value" id="workerUtilization">--%</span>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Tasks Processed</div>
                <div class="card-value" id="tasksProcessed">--</div>
                <div class="card-subtitle">
                    <span style="color: var(--danger-color);">‚úó Failed: <span id="tasksFailed">--</span></span> | 
                    <span style="color: var(--warning-color);">‚Üª Retried: <span id="tasksRetried">--</span></span>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Throughput</div>
                <div class="card-value" id="currentThroughput">--</div>
                <div class="card-subtitle">tasks/sec (current)</div>
                <div class="card-metric">
                    <span class="metric-label">Average</span>
                    <span class="metric-value"><span id="avgThroughput">--</span> tasks/sec</span>
                </div>
            </div>
        </div>

        <!-- Queue Depth Chart -->
        <div class="chart-container">
            <div class="chart-title">Queue Depth Over Time</div>
            <div class="chart-wrapper">
                <canvas id="queueChart"></canvas>
            </div>
        </div>

        <!-- Throughput Chart -->
        <div class="chart-container">
            <div class="chart-title">Throughput Over Time (Tasks/Second)</div>
            <div class="chart-wrapper">
                <canvas id="throughputChart"></canvas>
            </div>
        </div>

        <!-- Analytics Grid -->
        <div class="grid" style="grid-template-columns: 2fr 1fr;">
            <!-- Task Success/Failure Chart -->
            <div class="chart-container" style="margin-bottom: 0;">
                <div class="chart-title">Task Completion Ratio</div>
                <div class="chart-wrapper" style="height: 250px;">
                    <canvas id="taskRatioChart"></canvas>
                </div>
            </div>
            
            <!-- Task Processing Heatmap -->
            <div class="chart-container" style="margin-bottom: 0;">
                <div class="chart-title">Processing Activity (Last 24 Hours)</div>
                <div style="padding: 20px;">
                    <canvas id="heatmapChart" width="800" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
            <div class="card">
                <div class="card-title">Avg Processing Time</div>
                <div class="card-value" style="font-size: 1.5rem;" id="avgProcessingTime">--</div>
            </div>
            <div class="card">
                <div class="card-title">P95 Processing Time</div>
                <div class="card-value" style="font-size: 1.5rem;" id="p95ProcessingTime">--</div>
            </div>
            <div class="card">
                <div class="card-title">P99 Processing Time</div>
                <div class="card-value" style="font-size: 1.5rem;" id="p99ProcessingTime">--</div>
            </div>
            <div class="card">
                <div class="card-title">Tasks In Progress</div>
                <div class="card-value" style="font-size: 1.5rem;" id="tasksInProgress">--</div>
            </div>
            <div class="card">
                <div class="card-title">Dead Letter Queue</div>
                <div class="card-value" style="font-size: 1.5rem; color: var(--danger-color);" id="dlqSize">--</div>
            </div>
        </div>

        <!-- Live Activity Feed -->
        <div class="chart-container">
            <div class="chart-title">
                Live Activity Stream
                <span style="float: right; font-size: 0.875rem; font-weight: normal; color: var(--text-secondary);">
                    Last 20 events
                </span>
            </div>
            <div id="activityFeed" class="activity-feed">
                <div class="empty-state">
                    <div class="empty-state-icon">üìä</div>
                    <p>Waiting for task events...</p>
                </div>
            </div>
        </div>

        <!-- Tabbed Interface -->
        <div class="chart-container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('workers')">Workers</button>
                <button class="tab" onclick="switchTab('tasks')">Recent Tasks</button>
                <button class="tab" onclick="switchTab('dlq')">Dead Letter Queue</button>
            </div>

            <div id="workers-tab" class="tab-content active">
                <div class="chart-title">Worker Status</div>
                <div id="workersList" class="worker-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading workers...</p>
                    </div>
                </div>
            </div>

            <div id="tasks-tab" class="tab-content">
                <div class="chart-title">Recent Tasks</div>
                <div id="tasksList" class="task-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading tasks...</p>
                    </div>
                </div>
            </div>

            <div id="dlq-tab" class="tab-content">
                <div class="chart-title">Dead Letter Queue</div>
                <div id="dlqList" class="task-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading DLQ tasks...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="refresh-indicator">
        <div class="refresh-dot"></div>
        <span>Live Updates Active</span>
    </div>

    <script>
        // Global state
        let queueChart = null;
        let throughputChart = null;
        let taskRatioChart = null;
        let heatmapChart = null;
        let heatmapData = Array(24).fill(0); // 24 hours of data
        
        let queueDepthData = {
            labels: [],
            datasets: [{
                label: 'Queue Depth',
                data: [],
                borderColor: 'rgb(37, 99, 235)',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                tension: 0.4,
                fill: true
            }]
        };

        let throughputData = {
            labels: [],
            datasets: [{
                label: 'Tasks/Second',
                data: [],
                borderColor: 'rgb(16, 185, 129)',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
            }]
        };

        // Initialize Chart.js
        function initChart() {
            // Queue Depth Chart
            const ctxQueue = document.getElementById('queueChart').getContext('2d');
            queueChart = new Chart(ctxQueue, {
                type: 'line',
                data: queueDepthData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxTicksLimit: 10
                            }
                        }
                    }
                }
            });

            // Throughput Chart
            const ctxThroughput = document.getElementById('throughputChart').getContext('2d');
            throughputChart = new Chart(ctxThroughput, {
                type: 'line',
                data: throughputData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toFixed(2) + ' tasks/sec';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1);
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxTicksLimit: 10
                            }
                        }
                    }
                }
            });

            // Task Ratio Donut Chart
            const ctxRatio = document.getElementById('taskRatioChart').getContext('2d');
            taskRatioChart = new Chart(ctxRatio, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Failed', 'In Progress'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgb(16, 185, 129)',
                            'rgb(239, 68, 68)',
                            'rgb(245, 158, 11)'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 13
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return label + ': ' + value.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });

            // Heatmap (custom canvas drawing)
            initHeatmap();
        }

        // Initialize heatmap
        function initHeatmap() {
            const canvas = document.getElementById('heatmapChart');
            const ctx = canvas.getContext('2d');
            updateHeatmap(ctx);
        }

        // Update heatmap visualization
        function updateHeatmap(ctx) {
            const canvas = ctx.canvas;
            const width = canvas.width;
            const height = canvas.height;
            const cellsPerRow = 6;
            const rows = 4;
            const cellWidth = width / cellsPerRow;
            const cellHeight = height / rows;
            const padding = 2;

            ctx.clearRect(0, 0, width, height);

            // Get max value for normalization
            const maxValue = Math.max(...heatmapData, 1);

            // Draw cells
            for (let i = 0; i < 24; i++) {
                const intensity = heatmapData[i] / maxValue;
                const row = Math.floor(i / cellsPerRow);
                const col = i % cellsPerRow;

                const x = col * cellWidth;
                const y = row * cellHeight;

                // Color based on intensity (blue gradient)
                let color;
                if (intensity < 0.25) {
                    color = `rgba(219, 234, 254, 0.5)`;
                } else if (intensity < 0.5) {
                    color = `rgba(147, 197, 253, 0.7)`;
                } else if (intensity < 0.75) {
                    color = `rgba(59, 130, 246, 0.85)`;
                } else {
                    color = `rgba(37, 99, 235, 1)`;
                }

                ctx.fillStyle = color;
                ctx.fillRect(x + padding, y + padding, cellWidth - padding * 2, cellHeight - padding * 2);

                // Add hour label with better sizing
                const fontSize = Math.min(cellWidth / 4, 16);
                ctx.fillStyle = intensity > 0.5 ? '#ffffff' : '#374151';
                ctx.font = `bold ${fontSize}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const hour = i.toString().padStart(2, '0') + ':00';
                ctx.fillText(hour, x + cellWidth / 2, y + cellHeight / 2);
            }
        }

        // Update heatmap data based on current hour
        function updateHeatmapData(tasksProcessed) {
            const currentHour = new Date().getHours();
            heatmapData[currentHour] = tasksProcessed;
            
            const canvas = document.getElementById('heatmapChart');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                updateHeatmap(ctx);
            }
        }

        // Update dashboard with new metrics
        function updateDashboard(metrics) {
            // Update header
            document.getElementById('uptime').textContent = metrics.uptime;
            document.getElementById('lastUpdated').textContent = new Date(metrics.timestamp).toLocaleTimeString();
            
            const healthBadge = document.getElementById('queueHealth');
            healthBadge.textContent = metrics.queueHealth.charAt(0).toUpperCase() + metrics.queueHealth.slice(1);
            healthBadge.className = 'status-badge ' + (metrics.queueHealth === 'healthy' ? 'status-healthy' : 'status-unhealthy');

            // Update key metrics
            document.getElementById('queueDepth').textContent = metrics.queueDepth.toLocaleString();
            document.getElementById('queueDepthHigh').textContent = metrics.queueDepthHigh.toLocaleString();
            document.getElementById('queueDepthLow').textContent = metrics.queueDepthLow.toLocaleString();
            
            document.getElementById('activeWorkers').textContent = metrics.activeWorkers;
            document.getElementById('busyWorkers').textContent = metrics.busyWorkers;
            document.getElementById('idleWorkers').textContent = metrics.idleWorkers;
            document.getElementById('workerUtilization').textContent = metrics.workerUtilization.toFixed(1) + '%';
            
            document.getElementById('tasksProcessed').textContent = metrics.tasksProcessed.toLocaleString();
            document.getElementById('tasksFailed').textContent = metrics.tasksFailed.toLocaleString();
            document.getElementById('tasksRetried').textContent = metrics.tasksRetried.toLocaleString();
            
            document.getElementById('currentThroughput').textContent = metrics.currentThroughput.toFixed(2);
            document.getElementById('avgThroughput').textContent = metrics.avgThroughput.toFixed(2);
            
            // Update performance metrics
            document.getElementById('avgProcessingTime').textContent = metrics.avgProcessingTime;
            document.getElementById('p95ProcessingTime').textContent = metrics.p95ProcessingTime;
            document.getElementById('p99ProcessingTime').textContent = metrics.p99ProcessingTime;
            document.getElementById('tasksInProgress').textContent = metrics.tasksInProgress;
            document.getElementById('dlqSize').textContent = metrics.dlqSize;

            // Update queue depth chart
            if (metrics.queueTrend && metrics.queueTrend.length > 0) {
                queueDepthData.labels = metrics.queueTrend.map(p => {
                    const date = new Date(p.timestamp);
                    return date.toLocaleTimeString();
                });
                queueDepthData.datasets[0].data = metrics.queueTrend.map(p => p.depth);
                queueChart.update('none'); // Update without animation for smooth real-time updates
            }

            // Update throughput chart
            if (metrics.throughputTrend && metrics.throughputTrend.length > 0) {
                throughputData.labels = metrics.throughputTrend.map(p => {
                    const date = new Date(p.timestamp);
                    return date.toLocaleTimeString();
                });
                throughputData.datasets[0].data = metrics.throughputTrend.map(p => p.throughput);
                throughputChart.update('none');
            }

            // Update task ratio donut chart
            const completed = metrics.tasksProcessed - metrics.tasksFailed;
            const failed = metrics.tasksFailed;
            const inProgress = metrics.tasksInProgress;
            taskRatioChart.data.datasets[0].data = [completed, failed, inProgress];
            taskRatioChart.update('none');

            // Update heatmap
            updateHeatmapData(metrics.tasksProcessed);

            // Update workers list
            updateWorkersList(metrics);
        }

        // Update workers visualization
        function updateWorkersList(metrics) {
            const container = document.getElementById('workersList');
            if (metrics.activeWorkers === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-state-icon"></div>
                        <p>No active workers</p>
                    </div>
                `;
                return;
            }

            let html = '';
            
            // Generate worker items (mock data based on counts)
            for (let i = 0; i < metrics.busyWorkers; i++) {
                html += `
                    <div class="worker-item busy">
                        <div class="worker-id">worker-${i + 1}</div>
                        <div class="worker-status status-busy">‚óè BUSY</div>
                    </div>
                `;
            }
            for (let i = 0; i < metrics.idleWorkers; i++) {
                html += `
                    <div class="worker-item idle">
                        <div class="worker-id">worker-${metrics.busyWorkers + i + 1}</div>
                        <div class="worker-status status-idle">‚óè IDLE</div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // Fetch DLQ tasks
        function fetchDLQTasks() {
            fetch('/api/dlq')
                .then(res => res.json())
                .then(data => {
                    const container = document.getElementById('dlqList');
                    if (data.tasks.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">‚ú®</div>
                                <p>No failed tasks in Dead Letter Queue</p>
                                <p style="font-size: 0.875rem; margin-top: 8px;">All tasks are processing successfully!</p>
                            </div>
                        `;
                        return;
                    }

                    let html = '';
                    data.tasks.forEach(task => {
                        html += `
                            <div class="task-item failed" onclick="viewTaskDetail('${task.id}')">
                                <div class="task-header">
                                    <div>
                                        <div class="task-type">${task.type}</div>
                                        <div class="task-id">${task.id}</div>
                                    </div>
                                    <span class="task-state state-failed">${task.state}</span>
                                </div>
                                ${task.error ? `<div style="color: var(--danger-color); font-size: 0.875rem; margin-top: 8px;">Error: ${task.error}</div>` : ''}
                                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 8px;">
                                    Retries: ${task.retryCount}/${task.maxRetries} | Created: ${new Date(task.createdAt).toLocaleString()}
                                </div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                })
                .catch(err => {
                    console.error('Failed to fetch DLQ tasks:', err);
                });
        }

        // Fetch recent tasks
        function fetchRecentTasks() {
            fetch('/api/tasks')
                .then(res => res.json())
                .then(data => {
                    const container = document.getElementById('tasksList');
                    if (data.tasks.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">üìã</div>
                                <p>No recent tasks to display</p>
                                <p style="font-size: 0.875rem; margin-top: 8px;">Tasks will appear here as they are processed</p>
                            </div>
                        `;
                        return;
                    }

                    let html = '';
                    data.tasks.forEach(task => {
                        const stateClass = task.state === 'completed' ? 'completed' : 
                                          task.state === 'failed' ? 'failed' : 
                                          task.state === 'processing' ? '' : '';
                        const stateStyleClass = task.state === 'completed' ? 'state-completed' : 
                                               task.state === 'failed' ? 'state-failed' : 
                                               task.state === 'processing' ? 'state-processing' : 'state-pending';
                        
                        // Calculate duration if task has completed
                        let duration = '';
                        if (task.startedAt && task.completedAt) {
                            const start = new Date(task.startedAt);
                            const end = new Date(task.completedAt);
                            const ms = end - start;
                            duration = `${ms}ms`;
                        }

                        html += `
                            <div class="task-item ${stateClass}" onclick="viewTaskDetail('${task.id}')">
                                <div class="task-header">
                                    <div>
                                        <div class="task-type">${task.type}</div>
                                        <div class="task-id">${task.id}</div>
                                    </div>
                                    <span class="task-state ${stateStyleClass}">${task.state.toUpperCase()}</span>
                                </div>
                                ${task.error ? `<div style="color: var(--danger-color); font-size: 0.875rem; margin-top: 8px;">Error: ${task.error}</div>` : ''}
                                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 8px;">
                                    Priority: ${task.priority} | 
                                    ${duration ? `Duration: ${duration} | ` : ''}
                                    ${task.retryCount > 0 ? `Retries: ${task.retryCount} | ` : ''}
                                    Created: ${new Date(task.createdAt).toLocaleString()}
                                </div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                })
                .catch(err => {
                    console.error('Failed to fetch recent tasks:', err);
                    const container = document.getElementById('tasksList');
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">‚ö†Ô∏è</div>
                            <p>Failed to load tasks</p>
                            <p style="font-size: 0.875rem; margin-top: 8px;">Please check the connection</p>
                        </div>
                    `;
                });
        }

        // View task details
        function viewTaskDetail(taskId) {
            fetch(`/api/tasks/${taskId}`)
                .then(res => res.json())
                .then(task => {
                    alert(`Task Details:\n\nID: ${task.id}\nType: ${task.type}\nState: ${task.state}\nPriority: ${task.priority}\nRetries: ${task.retryCount}/${task.maxRetries}\n\n${task.error ? 'Error: ' + task.error : 'No errors'}`);
                })
                .catch(err => {
                    console.error('Failed to fetch task details:', err);
                    alert('Failed to load task details');
                });
        }

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');

            // Load data for specific tabs
            if (tabName === 'dlq') {
                fetchDLQTasks();
            } else if (tabName === 'tasks') {
                fetchRecentTasks();
            }
        }

        // Connect to WebSocket for real-time updates
        function connectWebSocket() {
            const eventSource = new EventSource('/api/ws');
            
            eventSource.addEventListener('metrics', function(event) {
                const metrics = JSON.parse(event.data);
                updateDashboard(metrics);
            });

            eventSource.addEventListener('task', function(event) {
                const taskEvent = JSON.parse(event.data);
                addTaskToActivityFeed(taskEvent);
            });

            // Fallback for older messages without event type
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    // Check if it's metrics data (has queueDepth property)
                    if (data.queueDepth !== undefined) {
                        updateDashboard(data);
                    }
                } catch (e) {
                    console.error('Error parsing message:', e);
                }
            };

            eventSource.onerror = function(error) {
                console.error('SSE error:', error);
                eventSource.close();
                
                // Reconnect after 5 seconds
                setTimeout(connectWebSocket, 5000);
            };
        }

        // Add task event to activity feed
        function addTaskToActivityFeed(taskEvent) {
            const feed = document.getElementById('activityFeed');
            
            // Remove empty state if present
            const emptyState = feed.querySelector('.empty-state');
            if (emptyState) {
                feed.innerHTML = '';
            }
            
            // Create activity item
            const item = document.createElement('div');
            item.className = `activity-item ${taskEvent.status}`;
            
            const icon = taskEvent.status === 'success' ? '‚úì' : '‚úó';
            const timeAgo = formatTimeAgo(new Date(taskEvent.timestamp));
            
            item.innerHTML = `
                <div class="activity-icon">${icon}</div>
                <div class="activity-details">
                    <div class="activity-type">${taskEvent.type}</div>
                    <div class="activity-meta">
                        <span class="activity-duration">‚è± ${taskEvent.duration}</span>
                        <span>ID: ${taskEvent.id.substring(0, 8)}...</span>
                    </div>
                </div>
                <div class="activity-timestamp">${timeAgo}</div>
            `;
            
            // Add to top of feed
            feed.insertBefore(item, feed.firstChild);
            
            // Keep only last 20 events
            while (feed.children.length > 20) {
                feed.removeChild(feed.lastChild);
            }
            
            // Auto-scroll to top to show new event
            feed.scrollTop = 0;
        }

        // Format time ago string
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 10) return 'just now';
            if (seconds < 60) return `${seconds}s ago`;
            
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            
            return date.toLocaleDateString();
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            connectWebSocket();
            fetchDLQTasks();
            
            // Auto-refresh tasks every 5 seconds
            setInterval(fetchRecentTasks, 5000);
        });
    </script>
</body>
</html>
